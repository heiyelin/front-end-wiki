# 浏览器本地存储

## Cookie

### 介绍

Cookie 最开始被设计出来并不是作为本地存储的，而是为了弥补 HTTP 在状态管理傻姑娘的不足。由于 HTTP 协议是一个无状态协议，客户端向服务器发送请求，服务器返回响应，一次请求过程就结束了。如果下一次发送请求，服务器并不能区分是否是同一个客户端。

Cookie 本质上就是浏览器里面存储的一个很小的文本文件，内部以键值对的方式来存储。向同一个域名下发送请求，都会携带相同的 Cookie，服务器拿到 Cookie 进行解析，便能拿到客户端的状态。

### 缺陷

Cookie 作为状态存储，有很多缺陷：

- 容量不足。Cookie 的体积上限只有 4KB，只能用来存储少量的信息。
- 性能缺陷。每次请求都会携带同域名下的所有 Cookie，造成不必要的性能浪费。
- 安全性差。由于 Cookie 以纯文本的形式在浏览器和服务器中传递，很容易被非法用户截获，然后进行一系列的篡改，在 Cookie 的有效期内重新发送给服务器，这是相当危险的。另外，在 HttpOnly 为 false 的情况下，Cookie 信息能直接通过 JS 脚本来读取。

### 设置 Cookie

| 属性      | 作用                                                           |
| --------- | -------------------------------------------------------------- |
| value     | 如果用于保存用户登录态，应该将该值加密，不能使用明文的用户标识 |
| http-only | 不能通过 JS 访问 Cookie，减少 XSS 攻击                         |
| secure    | 只能在协议为 HTTPS 的请求中携带                                |
| same-site | 规定浏览器不能在跨域请求中携带 Cookie，减少 CSRF 攻击          |

## localStorage

### 介绍

localStorage 是 HTML5 提出的作为持久保存客户端数据的方案。相比 Cookie 来说，它提供了更为直观的 API，且在安全上相对好一点。它具有以下优势：

- **存储量大**：localStorage 的容量上限为 5M。
- **安全性好**：只存储在客户端，不语服务端通信。
- **操作方便**：提供了直观的操作 API
- **持久性强**：如果不主动`removeItem()`或者`clear()`，即使关闭浏览器，存储的数据在下一次打开浏览器也还存在。

### 基本操作

```js
// 保存数据
locaStorage.setItem('name', 'Alin');
// 读取数据
locaStorage.getItem('name');
// 删除数据
locaStorage.removeItem('name');
// 移除所有
localStorage.clear();
```

## sessionStorage

### 介绍

sessionStorage 与 localStorage 相似，不同之处在于 localStorage 里面存储的数据没有过期时间设置，而 Session Storage 只存储当前会话页的数据，且只有当用户关闭当前会话页或浏览器时，数据才会被清除。

### 基本操作

```js
// 保存数据
sessionStorage.setItem('name', 'Alin');
// 读取数据
sessionStorage.getItem('name');
// 删除数据
sessionStorage.removeItem('name');
// 移除所有
sessionStorage.clear();
```

### 应用场景

- 可以用它对表单信息进行维护，将表单信息存储在里面，可以保证页面即使刷新也不会让之前的表单信息丢失。
- 可以用它存储本次浏览记录。如果关闭页面后不需要这些记录，用 sessionStorage 就再合适不过了。

## IndexedDB

### 介绍

IndexedDB 是运行在浏览器中的非关系型数据库, 本质上是数据库，用于客户端存储大量结构化数据(包括, 文件/ blobs)，并提供索引功能以实现高性能搜索。它一般用于保存大量用户数据并要求数据之间有搜索需要的场景，当网络断开时，用户就可以做一些离线的操作。它较之 SQL 更为方便，不需要写一些特定的语法对数据进行操作，数据格式是 JSON。

### 特性

- 支持事务
- 键值对存储。内部采用对象仓库存放数据，在这个对象仓库中数据采用键值对的方式来存储。
- 异步操作。数据库的读写属于 I/O 操作, 浏览器中对异步 I/O 提供了支持。
- 受同源策略限制，即无法访问跨域的数据库。

### 基本操作

[使用 IndexedDB](https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB)

## 总结

|     特性     |                   Cookie                   |       localStorage       | sessionStorage |        IndexedDB         |
| :----------: | :----------------------------------------: | :----------------------: | :------------: | :----------------------: |
| 数据生命周期 |     一般由服务器生成，可以设置过期时间     | 除非被清理，否则一直存在 | 页面关闭就清理 | 除非被清理，否则一直存在 |
| 数据存储大小 |                     4K                     |            5M            |       5M       |           无限           |
| 与服务端通信 | 每次都会携带在 header 中，对于请求性能影响 |          不参与          |     不参与     |          不参与          |
